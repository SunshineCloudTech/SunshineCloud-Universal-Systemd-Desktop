ARG VARIANT="focal"
FROM buildpack-deps:${VARIANT}
LABEL maintainer="SunshineCloudTech"
ENV container="docker"
ENV pip_packages="ansible"
USER root 
# Update package list and install basic packages
RUN apt-get update && apt-get upgrade -y && apt-get clean
# Enable systemd.
RUN apt-get update && \
    apt-get install -y --no-install-recommends systemd systemd-sysv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    (cd /lib/systemd/system/sysinit.target.wants/; for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done); \
    rm -f /lib/systemd/system/multi-user.target.wants/*;\
    rm -f /etc/systemd/system/*.wants/*;\
    rm -f /lib/systemd/system/local-fs.target.wants/*; \
    rm -f /lib/systemd/system/sockets.target.wants/*udev*; \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \
    rm -f /lib/systemd/system/basic.target.wants/*;\
    rm -f /lib/systemd/system/anaconda.target.wants/*;

# Install pip and other requirements.
RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    python3-pip \
    sudo xterm \
    curl wget \
    ca-certificates \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*
# Setup System User and Permissions  
RUN useradd -m "Administrator" -s /bin/bash && \
    echo "Administrator:123456789" | chpasswd && \
    echo "root:123456789" | chpasswd && \
    usermod -d /home/Administrator/ Administrator && \
    usermod -aG sudo Administrator && \
    useradd -m "matrix0523" -s /bin/bash && \
    echo "matrix0523:123456789" | chpasswd && \
    usermod -d /home/matrix0523/ matrix0523 && \
    usermod -aG sudo matrix0523 && \
    echo 'matrix0523 ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/matrix0523 && \
    # Create ollama user
    useradd -r -s /bin/false -U -m -d /usr/share/ollama ollama && \
    usermod -a -G ollama root && \
    usermod -a -G ollama Administrator && \
    usermod -a -G ollama matrix0523 && \
    # Setup Ollama directories and permissions
    mkdir -p /var/lib/ollama/models && \
    chown -R ollama:ollama /var/lib/ollama && \
    chmod -R 755 /var/lib/ollama

# Create Directory Structure
RUN mkdir -p /home/Administrator/Desktop /home/Administrator/Documents /home/Administrator/Downloads \
    /home/Administrator/Music /home/Administrator/Pictures /home/Administrator/Public \
    /home/Administrator/Templates /home/Administrator/thinclient_drives /home/Administrator/Videos && \
    mkdir -p /home/matrix0523/Desktop /home/matrix0523/Documents /home/matrix0523/Downloads \
    /home/matrix0523/Music /home/matrix0523/Pictures /home/matrix0523/Public \
    /home/matrix0523/Templates /home/matrix0523/thinclient_drives /home/matrix0523/Videos && \
    mkdir -p /app /SunshineCloud /lost+found && \
    mkdir -p /DATA/AppData /DATA/Documents /DATA/Downloads /DATA/Gallery /DATA/Compressed \
    /DATA/Desktop /DATA/Games /DATA/General /DATA/ISOS /DATA/Media /DATA/Others \
    /DATA/Programs /DATA/Public /DATA/Templates /DATA/Tools /DATA/Torrents /DATA/Videos && \
    mkdir -p /DATA/Media/Movies /DATA/Media/Music /DATA/Media/TV_Shows && \
    mkdir -p /SunshineCloud/AppData /SunshineCloud/Documents /SunshineCloud/Downloads \
    /SunshineCloud/Gallery /SunshineCloud/Compressed /SunshineCloud/Desktop \
    /SunshineCloud/Games /SunshineCloud/General /SunshineCloud/ISOS /SunshineCloud/Media \
    /SunshineCloud/Others /SunshineCloud/Programs /SunshineCloud/Public \
    /SunshineCloud/Templates /SunshineCloud/Tools /SunshineCloud/Torrents /SunshineCloud/Videos && \
    mkdir -p /SunshineCloud/Media/Movies /SunshineCloud/Media/Music /SunshineCloud/Media/TV_Shows && \
    mkdir -p /media/appdata /media/documents /media/downloads /media/gallery /media/compressed \
    /media/desktop /media/games /media/general /media/isos /media/media /media/others \
    /media/programs /media/public /media/templates /media/tools /media/torrents /media/videos && \
    mkdir -p /media/media/movies /media/media/music /media/media/tv_shows && \
    mkdir -p /var/run/dbus && \
    chown -R Administrator:Administrator /home/Administrator && \
    chown -R matrix0523:matrix0523 /home/matrix0523
# Install Ansible via Pip.
RUN pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
RUN pip3 install $pip_packages
# Disable requiretty.
RUN sed -i -e 's/^\(Defaults\s*requiretty\)/#--- \1/'  /etc/sudoers
# Install Ollama
# RUN curl -fsSL https://ollama.com/install.sh | sh
# Install Ansible inventory file.
RUN mkdir -vp /etc/ansible
RUN echo '[local]\nlocalhost ansible_connection=local' > /etc/ansible/hosts

VOLUME ["/sys/fs/cgroup", "/tmp", "/run"]
ENTRYPOINT [ "/lib/systemd/systemd" ]