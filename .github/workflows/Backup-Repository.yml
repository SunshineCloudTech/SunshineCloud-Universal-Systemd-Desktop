name: SunshineCloud-Universal-Systemd-Desktop-Backup

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run backup every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: write
  actions: read

jobs:
  backup-repository:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history
        submodules: 'recursive'
        token: ${{ secrets.REPO_TOKEN }}

    - name: Get current date and time
      id: datetime
      run: |
        echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Backup Package
      run: |
        # Create backup directory
        mkdir -p backup
        
        # Create a comprehensive backup archive
        tar --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='backup' \
            --exclude='*.tmp' \
            --exclude='.vscode' \
            --exclude='.idea' \
            -czf backup/SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.tar.gz \
            .
        
        # Create a git bundle as additional backup
        git bundle create backup/SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.bundle --all
        
        # List created files
        ls -la backup/
        
        # Calculate checksums
        cd backup
        sha256sum *.tar.gz *.bundle > checksums.sha256
        cat checksums.sha256

    - name: Upload Backup Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SunshineCloud-Universal-Systemd-Desktop-backup-${{ steps.datetime.outputs.timestamp }}
        path: backup/
        retention-days: 30
    # Create GitHub Release with backup files
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          backup/SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.tar.gz
          backup/SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.bundle
          backup/checksums.sha256
        body: |
          ## ğŸ—„ï¸ SunshineCloud-Universal-Systemd-Desktop Repository Backup
          
          **å¤‡ä»½æ—¥æœŸ:** ${{ steps.datetime.outputs.date }}
          **æäº¤ SHA:** ${{ steps.datetime.outputs.commit_sha }}
          **å¤‡ä»½æ–‡ä»¶:**
          
          - ğŸ“¦ `SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.tar.gz` - å®Œæ•´æºä»£ç å­˜æ¡£
          - ğŸ”— `SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.bundle` - Git ä»“åº“åŒ…
          - ğŸ” `checksums.sha256` - SHA256 æ ¡éªŒå’ŒéªŒè¯æ–‡ä»¶
          
          ### ğŸ“‹ å¤‡ä»½å†…å®¹
          - å®Œæ•´çš„æºä»£ç å’Œé…ç½®æ–‡ä»¶
          - Systemd å®¹å™¨é•œåƒæ„å»ºé…ç½® (Debian Bookworm/Bullseye, Ubuntu Noble/Jammy/Focal)
          - æ¡Œé¢ç¯å¢ƒ Dockerfiles (KDE/GNOME/Xfce)
          - VS Code Dev Container é…ç½®
          - å¤šæ¶æ„æ”¯æŒ (AMD64/ARM64)
          - GitHub Actions è‡ªåŠ¨åŒ–å·¥ä½œæµ
          - Docker Compose é…ç½®æ–‡ä»¶
          - æ–‡æ¡£å’Œè®¸å¯è¯æ–‡ä»¶
          - æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
          
          ### ğŸ” éªŒè¯å’Œä½¿ç”¨
          ```bash
          # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          sha256sum -c checksums.sha256
          
          # è§£å‹å­˜æ¡£
          tar -xzf SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.tar.gz
          
          # ä» bundle å…‹éš†
          git clone SunshineCloud-Universal-Systemd-Desktop-${{ steps.datetime.outputs.timestamp }}.bundle restored-repo
          ```
          
          ### ğŸš€ é¡¹ç›®ç‰¹æ€§
          - å¤šå‘è¡Œç‰ˆ Systemd å®¹å™¨æ”¯æŒ (Debian 11/12, Ubuntu 20.04/22.04/24.04)
          - å¤šæ¶æ„é•œåƒæ„å»º (AMD64, ARM64)
          - æ¡Œé¢ç¯å¢ƒæ”¯æŒ (KDE Plasma, GNOME, Xfce)
          - xRDP è¿œç¨‹æ¡Œé¢è®¿é—®
          - å®Œæ•´çš„å¼€å‘å·¥å…·é“¾ (Node.js, Python, Go, Rust, Java, PowerShell)
          - DevContainer å¼€å‘ç¯å¢ƒ
          - Docker-in-Docker æ”¯æŒ
          - å®¹å™¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆ
          
          ---
          *GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„å¤‡ä»½*
        tag_name: backup-${{ steps.datetime.outputs.timestamp }}
        name: "Repository Backup - ${{ steps.datetime.outputs.date }}"
        draft: false
        prerelease: false
        token: ${{ secrets.REPO_TOKEN }}
        make_latest: false